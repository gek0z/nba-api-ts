# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
bun run build              # Bundle ESM + emit .d.ts declarations
bun run lint               # Biome check (formatting + linting)
bun run lint:fix           # Auto-fix lint/format issues
bun run typecheck          # tsc --noEmit
bun run docs               # Generate API docs (TypeDoc → docs/)
bun test                   # All tests (integration skipped without env var)
bun run test:unit          # Unit tests only (offline, fast)
bun test tests/unit/stats/endpoints.test.ts                  # Single test file
bun test tests/unit/stats/endpoints.test.ts -t "playerCar"   # Single test by name

# Integration tests — hits real NBA API, requires residential IP
NBA_INTEGRATION_TESTS=1 bun run test:integration
NBA_INTEGRATION_TESTS=1 NBA_USE_TLS=1 bun run test:integration:tls
```

## Architecture

Zero-dependency TypeScript client wrapping **138 stats endpoints** (`stats.nba.com`) and **4 live endpoints** (`cdn.nba.com`).

### HTTP layer (`src/http/`)
`FetchClient` handles all requests with retry (exponential backoff on 408/429/5xx), rate limiting (token-bucket, default 600ms), timeout via AbortController, and custom `fetch` injection for TLS fingerprint bypass.

### Endpoint pattern (`src/stats/endpoints/`)
Every stats endpoint is a pure function: `(FetchClient, Params) → Promise<Response>`. Params are camelCase in TypeScript, converted to PascalCase for the NBA API. The `StatsClient` class (`src/stats/index.ts`) binds all 138 endpoint functions to its `FetchClient` instance.

### Response parsing (`src/response/`)
NBA returns `{ headers: string[], rowSet: any[][] }` arrays. The parser converts these to typed objects with camelCase keys (`PLAYER_ID` → `playerId`). Two variants: `parseStatsResponse` for V2 and `parseStatsV3Response` for V3 format.

### Live data (`src/live/`)
4 simple JSON endpoints on `cdn.nba.com` — no Akamai protection, no parsing needed, no rate limiting.

### Type system (`src/stats/types/`)
Each endpoint has a type file with `{Endpoint}Params`, `{Endpoint}Response`, and `{ResultSet}Row` interfaces.

## Adding a new stats endpoint

1. `src/stats/types/{name}.ts` — Params + Response + Row interfaces
2. `src/stats/endpoints/{name}.ts` — endpoint function
3. `src/stats/endpoints/index.ts` — re-export
4. `src/stats/index.ts` — add method to `StatsClient`, add imports

## Conventions

- **Formatting**: tabs, double quotes (Biome)
- **Always use `bun`** — not npm/yarn/pnpm
- Stats endpoints use PascalCase query params (`PlayerID`, `PerMode`), TypeScript interfaces use camelCase (`playerID`, `perMode`)
- Integration tests are gated behind `NBA_INTEGRATION_TESTS=1` env var
- PR titles must follow conventional commits (`feat:`, `fix:`, `docs:`, `ci:`, etc.) — this drives auto-labeling and version bumps
- `docs/` is gitignored (generated by TypeDoc)

## CI/CD

- **CI** (`.github/workflows/integration.yml`): runs lint, typecheck, unit tests on push/PR to main
- **Publish** (`.github/workflows/publish.yml`): bumps version, publishes to npm, creates GitHub release — only when source files change (`src/`, `package.json`, `tsconfig.json`) and PR title follows conventional commits
- **Docs** (`.github/workflows/docs.yml`): builds TypeDoc and deploys to GitHub Pages (`nba-api-ts.riccardo.lol`) — only when `src/`, `typedoc.json`, `tsconfig.json`, or the workflow itself change
- **Label PR** (`.github/workflows/label-pr.yml`): auto-labels PRs with `patch`/`minor`/`major` based on conventional commit title
- **Dependabot** (`.github/dependabot.yml`): weekly grouped PRs for npm and GitHub Actions updates

## Documentation

- `ENDPOINTS.md` — full list of all 138 stats + 4 live endpoints with NBA API paths
- TypeDoc site at `nba-api-ts.riccardo.lol` — auto-generated from source, deployed via GitHub Pages
- Config: `typedoc.json` (entry points, output dir, options)

## Akamai constraints

`stats.nba.com` blocks non-browser TLS fingerprints and datacenter IPs. Stats endpoints only work from residential IPs with TLS impersonation (e.g., `tlsclientwrapper`). Live endpoints (`cdn.nba.com`) work from anywhere. CI runs unit tests only.
